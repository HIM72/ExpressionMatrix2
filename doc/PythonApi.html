<!DOCTYPE html>
<html>

<head>
<link rel=stylesheet href=style.css />
<link rel=icon href="https://s0.wp.com/wp-content/themes/vip/czi/images/build/favicon.ico" />
</head>

<body>

<h1>Starting a run and analyzing results using the Python API</h1>



<h2>Accessing ExpressionMatrix2 functionality from Python code</h2>

<p>Users access ExpressionMatrix2 functionality via shared library ExpressionMatrix2.so, which can by imported in a Python script as a Python package. The build assumes that the library will be used with Python Version 3, but could be modified (by changing some include file paths and library names) to work with Python 2 instead. You can import ExpressionMatrix2 in Python 3 code just like any other Python package, for example adding the following near the beginning of your Python script or after starting a Python shell for interactive use:

<pre>
import ExpressionMatrix2
</pre>

<p>For this to work, the ExpressionMatrix2 library must be made available to the Python interpreter in one of the standard ways - for example:

<ul>
<li>Set environment variable PYTHONPATH to point to the directory containing the library.
<li>Make a copy of the library in the directory which is the current directory at the time the Python import command executes. A symbolic link will also work.
</ul>

<p>All the code examples in the next sections assume that the import command before was executed successfully.



<h2>Creating and accessing expression matrix objects</h2>

<p>To begin working with a new data set, you must first create a new Python object to describe the expression matrix for the new data set. This can be done as shown in the following example:

<pre>
parameters = ExpressionMatrix2.ExpressionMatrixCreationParameters()
parameters.geneCapacity = 50000                 # Maximum number of genes.
parameters.cellCapacity = 100000                # Maximum number of cells.           
parameters.cellMetaDataNameCapacity = 10000     # Maximum number of distinct cell meta data name strings.
parameters.cellMetaDataValueCapacity = 1000000  # Maximum number of distinct cell meta data value strings.
e = ExpressionMatrix.ExpressionMatrix('data', parameters)
</pre>

<p>The parameters object is used to specify the capacity of various hash tables used to store genes, cells, and cell meta data, as explained in the comments. Keep in mind that the present version of the code does not provide a way to redefine these capacities later by rehashing the tables. 

<p> The last line creates the expression matrix object. The first parameter is the name of a directory that will be used to hold various binary files containing expression matrix data structures. The directory will be create is it does not exist.

<p>Since most data structures are stored in files, the expression matrix object is persistent: it can be reaccessed in the future, even after the Python object used for the original creation disappears. This can be done by simply specifying the name of the directory containing the binary data, without specifying creation parameters:

<pre>
e = ExpressionMatrix.ExpressionMatrix('data')
</pre>

<p>The code examples in the next sections assume that an expression matrix object named "e" was accessed in one of the two ways shown in this section.



<h2 id=addCells>Adding cells</h2>

<p>After the expression matrix object is first created, the first thing you will want to do is add cells to it. To provide flexibility in adding cells, three paths to add cells are provided:

<ul>
<li>Function <code>addCells</code> can be used to add cells and meta data from files in comma separated format (csv) or similar delimited formats.
<li>Function <code>addCellsFromHdf5</code> can be used to add cells from expression matrix data in HDF5 format created by the 10x Genomics pipeline.
<li>Function <code>addCell</code> can be used to add a single cell and meta data specified using a simple JSON format.
</ul>

<p>Each of these three methods is described in more details in one of the sections below. You can use any combination of the three methods, in any sequence, to add different batches of cells to a single expression matrix object. In that case, each batch can use a different set of cell meta data names.



<h3>Adding cells in comma separated format or similar delimited formats</h3>

<p>You can use this path if you have a text file containing a dense representation of the expression matrix. This file can be a standard comma separated file (csv), which follows the following rules:

<ul>
<li>Fields in each row are separated by commas or any other separator, which is specified when calling addCells.
<li>A field cannot contain a separator, unless the entire field is enclosed quotes or the separator is escaped (preceeded by an extra "\" character).
<li>If a field contains quotes, the quotes in the field must be escaped (preceeded by an extra "\" character).
</ul>

<p>
The expression matrix file has a row for each gene and a column for each cell, plus an initial row containing cell names and an initial column containing gene names. The first field of the first row is optional, and is ignored if present. Except for the initial row and column, each entry in the file contains a number which is the expression count for the gene and cell corresponding to the row and column that the field belongs to. These expression counts do not have to be integers (floating-point values are accepted), so prenormalization or recalibration of the data can be done, if desired (for example to convert reads to reads per Megabase, or to apply a logarithm or other non-linear function to alter the weighing of low expression counts).

<p> As an example of an expression matrix in this format, here is the one used for the small test case in tests/ToyTest1:

<pre>
Gene,Cell0,Cell1,Cell2
Gene0,10,0,0
Gene1,10,10,0
Gene3,0,10,20
</pre>

<p>
Some pipelines create expression matrices that contain rows, near the beginning or the end of the file, which contain extraneous information other than gene expression data. Such information must be removed before the file is used as input to the ExpressionMatrix2 code. Also, expression counts for artificial ERCC sequence should be removed from the expression file, if present.

<p>
An input file containing cell meta data must also be provided. The cell meta data file is formatted similarly to the expression matrix file, and contains a row for each cell and a column for each meta data field, plus an initial column containing cell names and an initial row containing meta data field names. Like for the expression matrix file, the first field of the first row is optional, and is ignored if present. 

<p> Here is an example of a cell meta data file in this format, also taken from the small test case in tests/ToyTest1:

<pre>
Cell,Organ,Tumor
Cell0,Brain,Yes
Cell1,Liver,No
Cell2,Pancreas,No
</pre>

<p>
The cell names in the first row of the expression count file and in the first column of the meta data file don't have to be in the same order. If a cell name is present in only one of the files, that cell is ignored. This allows using pipelines in which one or both of the files contain information for additional cells that are to be ignored. 

<p>
If either the expression file or the meta data file were generated by a Windows system, you will need to use the dos2unix command to convert the line ends. If dos2unix is not available and you are on ubuntu 16.04, install it using command "apt install dos2unix" (this requires root privileges).

<p>
You can use Python code like this to add to an expression matrix a set of cells described in this format:

<pre>
e.addCells('ExpressionMatrix.csv', ',', 'MetaData.csv', ',', maxTermCountForApproximateSimilarityComputation)
</pre>

<p>
Here is the meaning of the arguments to the <code>addCells</code> call:

<ul>
<li>The name of the expression matrix file.
<li>The separator or separators used in the expression matrix file.
<li>The name of the cell meta data file.
<li>The separator or separators used in the cell meta data file.
<li>The maximum number of genes to be used for approximate similarity computations involving these cells. A value of 100 is usually appropriate.
</ul>

<p>
Note that, when using this format, the expression matrix read on input is represented in a dense format - that is, all of its entries are explicitly present, including the ones that are zero. Therefore this format becomes unpractical for large runs. Because information for each cell is stored in columns of the expression matrix file, the entire file has to be read into memory. As a result, the input process requires much more memory than if using more space efficient formats like the ones described in the next sections.




<h3>Adding cells from expression matrix data in HDF5 format created by the 10x Genomics pipeline</h3>

<p>
The 10X Genomics RNA pipeline creates expression matrix data in <a href="https://en.wikipedia.org/wiki/Hierarchical_Data_Format">HDF5 format</a>. <a href="https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/advanced/h5_matrices">This format</a> is very space efficient because the expression matrix is stored in sparse format (only the non-zero entries are stored), and in addition it is also compressed. It is also memory efficient because the data in the file are stored by cell, not by gene, and as a result it is not necessary to load the entire file in memory for processing.

<p>
If you want use one of these files as input to the ExpressionMatrix2 code and you are on ubuntu, it is suggested that you install package hdf5-tools from the standard ubuntu repositories. This provides a variety of commands that are useful to manipulate HDF5 files. For example, you can use the following command to list the data sets contained in an HDF5 file:

<pre>
h5ls -r file.h5 
/                        Group
/GRCh38                  Group
/GRCh38/barcodes         Dataset {8083}
/GRCh38/data             Dataset {8863417/Inf}
/GRCh38/gene_names       Dataset {33694}
/GRCh38/genes            Dataset {33694}
/GRCh38/indices          Dataset {8863417/Inf}
/GRCh38/indptr           Dataset {8084/8192}
/GRCh38/shape            Dataset {2/16384}
</pre>

<p>
The ExpressionMatrix2 code requires the following HDF5 data sets to be present, below the top level HDF5 group:

<ul>
<li>Data set <code>genes</code>, which contains <a href="https://en.wikipedia.org/wiki/Ensembl_genome_database_project">Ensembl</a> gene ids. Data set <code>gene_names</code> is not used, even though it contains more friendly gene names, because the 10X pipeline does not guarantee these names to be unique.
<li>Data set <code>barcodes</code>, which contains barcodes which are used as cell names.
<li>Data sets <code>data, indices, indptr</code>, which contain the non-zero elements of the expression matrix in <a href="http://www.scipy-lectures.org/advanced/scipy_sparse/csc_matrix.html">column-compressed sparse format</a>.
</ul>

<p>
You can use Python code like this to add to an expression matrix a set of cells described in this format:

<pre>
e.addCellsFromHdf5('file.h5', maxTermCountForApproximateSimilarityComputation)
</pre>

<p>
Here, the first parameter specified the name of the HDF5 and the second parameter specifies the maximum number of genes to be used for approximate similarity computations involving these cells. A value of 100 is usually appropriate. Note then, when using this format, cells have no meta data except for their name.



<h3>Adding cells in simple JSON format</h3>

<p>
If your expression data are in a custom format, you can write Python code to create a simple JSON for each cell you want to add, then call function <code>addCell</code> passing the JSON as the argument. This simple example shows the format of the expected JSON and the Python code required to add the cell to an expression matrix object:

<code>
import json
cell = {'metaData': {'cellName': 'abc', 'key1': 'value1'}, 'expressionCounts': {'gene1': 10,'gene2': 20}}
e.addCell(json.dumps(jSonString), maxTermCountForApproximateSimilarityComputation)
</code>

<p>
Each cell is required ot have the <code>cellName</code> meta data field, but other than that the set of meta data for each cell is completely arbitrary. each cell can have a different set of meta data fields.

<p>
As before, the last parameter specifies the maximum number of genes to be used for approximate similarity computations involving these cells. A value of 100 is usually appropriate.




</body>
</html>
